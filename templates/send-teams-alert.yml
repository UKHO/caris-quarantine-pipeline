#*** Add File: C:\Git\caris-quarantine-pipeline\templates\send-teams-alert.yml
#@@
## Template: Send a Teams message via an incoming webhook
## Parameters: webhookUrl (string), title, message, status, sourceHost, sourceRepository, sourceTag,
## destinationImage, preImage, vulnerableImage, preVulnerableImage, pipelineUrl
parameters:
  - name: webhookUrl
    type: string
    default: ''
  - name: title
    type: string
    default: ''
  - name: message
    type: string
    default: ''
  - name: status
    type: string
    default: ''
  - name: sourceHost
    type: string
    default: ''
  - name: sourceRepository
    type: string
    default: ''
  - name: sourceTag
    type: string
    default: ''
  - name: destinationImage
    type: string
    default: ''
  - name: preImage
    type: string
    default: ''
  - name: vulnerableImage
    type: string
    default: ''
  - name: preVulnerableImage
    type: string
    default: ''
  - name: pipelineUrl
    type: string
    default: ''

steps:
- task: PowerShell@2
  displayName: 'Send Teams alert'
  inputs:
    targetType: 'inline'
    script: |
      # Read parameters from environment to avoid param() expansion issues
      $webhookUrl = '${{ parameters.webhookUrl }}'
      $title = '${{ parameters.title }}'
      $message = '${{ parameters.message }}'
      $status = '${{ parameters.status }}'
      $sourceHost = '${{ parameters.sourceHost }}'
      $sourceRepository = '${{ parameters.sourceRepository }}'
      $sourceTag = '${{ parameters.sourceTag }}'
      $destinationImage = '${{ parameters.destinationImage }}'
      $preImage = '${{ parameters.preImage }}'
      $vulnerableImage = '${{ parameters.vulnerableImage }}'
      $preVulnerableImage = '${{ parameters.preVulnerableImage }}'
      $pipelineUrl = '${{ parameters.pipelineUrl }}'

      if ([string]::IsNullOrWhiteSpace($webhookUrl)) {
        Write-Host "Teams webhook URL is empty; skipping Teams alert."
        exit 0
      }

      $color = if ($status -eq 'success') { '00AA00' } else { 'AA0000' }

      $summary = $title

      $sections = @()
      $sections += @{ activityTitle = $title; activitySubtitle = $message }

      $facts = @()
      if ($sourceHost) { $facts += @{ name = 'Source host'; value = $sourceHost } }
      if ($sourceRepository) { $facts += @{ name = 'Repository'; value = $sourceRepository } }
      if ($sourceTag) { $facts += @{ name = 'Tag'; value = $sourceTag } }
      if ($destinationImage) { $facts += @{ name = 'Destination'; value = $destinationImage } }
      if ($preImage) { $facts += @{ name = 'Pre destination'; value = $preImage } }
      if ($vulnerableImage) { $facts += @{ name = 'Vulnerable image'; value = $vulnerableImage } }
      if ($preVulnerableImage) { $facts += @{ name = 'Pre vulnerable image'; value = $preVulnerableImage } }
      if ($pipelineUrl) { $facts += @{ name = 'Pipeline'; value = $pipelineUrl } }

      if ($facts.Count -gt 0) {
        $sections[0].facts = $facts
      }

      $payload = @{ '@type' = 'MessageCard'; '@context' = 'http://schema.org/extensions'; summary = $summary; themeColor = $color; sections = $sections } | ConvertTo-Json -Depth 10

      try {
        Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -ContentType 'application/json'
        Write-Host "Teams alert sent (status=$status)"
      } catch {
        Write-Host "Failed to send Teams alert: $($_.Exception.Message)"
        # don't fail the pipeline solely because the notification failed
      }
