trigger: none
pr: none

resources:
  webhooks:
    - webhook: AcrHelmWebhookTrigger
      connection: AcrWebhookConnection
      filters:
        - path: target.mediaType
          value: "application/vnd.cncf.helm.config.v1+json"

variables:
  - group: caris-quarantine
  - name: sourceAzureSubscription
    value: 'quarantine-helm-publicacr'
  - name: preAzureSubscription
    value: 'quarantine-helm-preacr'
  - name: liveAzureSubscription
    value: 'quarantine-helm-liveacr'
  - name: sourceRegistryServiceConnection
    value: 'publiccrlive-docker' 
  - name: destinationRegistryServiceConnection
    value: 'carisliveacr-docker'
  - name: preRegistryServiceConnection
    value: 'carispreacr-docker'
  - name: destinationRegistry
    value: 'carisliveacr.azurecr.io'
  - name: preRegistry
    value: 'carispreacr.azurecr.io'
  - name: snykServiceConnection
    value: 'SnykAuth'
  - name: snykOrganization
    value: 'caris-cloud'

stages:
- template: templates/helm-scan-template.yml
  parameters:
    sourceAzureSubscription: '$(sourceAzureSubscription)'
    preAzureSubscription: '$(preAzureSubscription)'
    liveAzureSubscription: '$(liveAzureSubscription)'
    sourceRegistryServiceConnection: '$(sourceRegistryServiceConnection)'
    destinationRegistryServiceConnection: '$(destinationRegistryServiceConnection)'
    preRegistryServiceConnection: '$(preRegistryServiceConnection)'
    destinationRegistry: '$(destinationRegistry)'
    preRegistry: '$(preRegistry)'
    snykServiceConnection: '$(snykServiceConnection)'
    snykOrganization: '$(snykOrganization)'
    teamsWebhookEndpoint: '$(teamsWebhookEndpoint)'
    sourceRepository: ${{ coalesce(parameters.AcrHelmWebhookTrigger.target.repository, 'unknown') }}
    sourceTag: ${{ coalesce(parameters.AcrHelmWebhookTrigger.target.tag, parameters.AcrHelmWebhookTrigger.target.version, 'unknown') }}
    sourceHost: ${{ coalesce(parameters.AcrHelmWebhookTrigger.request.host, 'unknown') }}
